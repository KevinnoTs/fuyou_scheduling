{% extends "base.html" %}

{% block wrapper_class %}fixed-wrapper{% endblock %}

{% block content %}
<div class="card full-screen-card">
    <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; position: relative;">
        <h2 style="flex-grow: 1;">用户管理</h2>
        <button class="action-toggle-btn" onclick="toggleActions()">
            ☰
        </button>
        <div class="action-bar" id="userActions">
            <div class="action-content-wrapper">
                <input type="text" id="searchInput" class="form-control" placeholder="搜索用户名或姓名..."
                    style="width: 200px; display: inline-block;" onkeyup="filterTable()">

                {% if current_user.role in ['admin', 'super_admin'] %}
                <a href="{{ url_for('add_user') }}" class="btn-primary">＋ 添加用户</a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="table-container">
        <table id="usersTable">
            <thead>
                <tr>
                    <th style="width: 8rem; min-width: 8rem;">用户名</th>
                    <th style="width: 4rem; min-width: 4rem;">姓名</th>
                    <th style="width: 6rem; min-width: 6rem;">权限等级</th>
                    <th style="width: 5rem; min-width: 5rem;">关联医生</th>
                    <th style="width: 3rem; min-width: 3rem;">状态</th>
                    <th style="width: 4rem; min-width: 4rem; text-align: center;">操作</th>
                    <!-- Spacer Column -->
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr class="{% if current_user.id == user.id %}current-user-row{% endif %}">
                    <td>{{ user.username }}</td>
                    <td>{{ user.real_name }}</td>
                    <td>
                        {% if user.role == 'super_admin' %}
                        <span
                            style="background-color: #d63031; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">超级管理员</span>
                        {% elif user.role == 'admin' %}
                        <span
                            style="background-color: #e67e22; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">管理员</span>
                        {% elif user.role == 'assistant' %}
                        <span
                            style="background-color: #b2bec3; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">普通医助</span>
                        {% else %}
                        <span
                            style="background-color: #3498db; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">普通医师</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.doctor %}
                        <span style="color: var(--primary-color); font-weight: bold;">{{ user.doctor.name }}</span>
                        {% else %}
                        <span style="color: var(--text-light);">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.is_active %}
                        <span style="color: green; font-weight: bold;">正常</span>
                        {% else %}
                        <span style="color: red; font-weight: bold;">禁用</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <a href="{{ url_for('edit_user', id=user.id) }}" class="btn-outline"
                                style="font-size: 0.8rem; padding: 0.2rem 0.5rem;">编辑</a>
                        </div>
                    </td>
                    <!-- Spacer Cell -->
                    <td></td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-light);">
                        未找到匹配的用户。
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleActions() {
        var actions = document.getElementById('userActions');
        actions.classList.toggle('show');
    }

    // Close actions when clicking outside
    window.addEventListener('click', function (e) {
        var actions = document.getElementById('userActions');
        var btn = document.querySelector('.action-toggle-btn');
        if (!actions.contains(e.target) && !btn.contains(e.target) && actions.classList.contains('show')) {
            actions.classList.remove('show');
        }
    });

    function filterTable() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        const table = document.getElementById('usersTable');
        const tr = table.getElementsByTagName('tr');

        for (let i = 1; i < tr.length; i++) {
            // Skip if it's the "No data" row
            if (tr[i].getElementsByTagName('td').length < 2) continue;

            const usernameTd = tr[i].getElementsByTagName('td')[0];
            const realnameTd = tr[i].getElementsByTagName('td')[1];

            if (usernameTd && realnameTd) {
                const usernameValue = usernameTd.textContent || usernameTd.innerText;
                const realnameValue = realnameTd.textContent || realnameTd.innerText;

                if (usernameValue.toLowerCase().indexOf(filter) > -1 || realnameValue.toLowerCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
</script>
{% endblock %}