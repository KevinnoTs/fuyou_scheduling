{% extends "base.html" %}

{% block wrapper_class %}fixed-wrapper{% endblock %}

{% block content %}
<style>
    .calendar-container {
        overflow-x: auto;
        padding-bottom: 5px;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, minmax(130px, 1fr));
        gap: 2px;
        background-color: #bbb;
        border: 2px solid #bbb;
        border-radius: 8px;
    }

    .calendar-header {
        background-color: var(--bg-light);
        padding: 12px;
        text-align: center;
        font-weight: bold;
        color: var(--text-light);
        font-size: 0.95rem;
    }

    .calendar-link {
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .calendar-cell {
        background-color: var(--white);
        aspect-ratio: 1 / 1;
        padding: 8px 12px;
        display: flex;
        flex-direction: column;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
    }

    .calendar-cell:hover {
        background-color: var(--bg-light);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        z-index: 1;
    }

    .date-number {
        font-weight: 700;
        font-size: 2.2rem;
        margin-bottom: 8px;
        line-height: 1;
        color: var(--primary-color);
    }

    .calendar-cell.holiday .date-number {
        color: #dc3545;
    }

    .calendar-cell.holiday {
        background-color: var(--white);
    }

    .calendar-cell.weekend .date-number {
        color: #6c757d;
    }

    .calendar-cell.workday .date-number {
        color: var(--primary-color);
    }

    .calendar-cell.workday {
        background-color: var(--white);
    }

    .calendar-tag {
        position: absolute;
        top: 8px;
        right: 8px;
        font-size: 0.75rem;
        padding: 1px 4px;
        border-radius: 4px;
        line-height: 1;
        font-weight: normal;
        border: 1px solid;
        background-color: var(--white);
    }

    .tag-holiday {
        color: #dc3545;
        border-color: #dc3545;
    }

    .tag-workday {
        color: var(--text-main);
        border-color: var(--text-light);
    }

    body.dark .tag-workday {
        color: var(--text-main);
        border-color: var(--text-light);
        background-color: #2d2d2d;
    }

    body.dark .tag-holiday {
        background-color: #2d2d2d;
    }

    /* Dark Mode Overrides for Calendar Grid and Text */
    body.dark .calendar-grid {
        background-color: #444;
        border-color: #444;
    }

    body.dark .stat-label {
        color: #bbb;
    }

    .stat-item {
        font-size: 0.8rem;
        margin-bottom: 2px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: var(--text-light);
    }

    .stat-label {
        font-size: 0.75rem;
        color: #555;
        font-weight: bold;
    }

    .stat-value {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text-main);
    }

    .score-value {
        color: var(--text-main);
        font-size: 0.9rem;
    }

    /* Integrated Summary Styling */
    .summary-bar {
        display: flex;
        gap: 2rem;
        margin-right: 1rem;
        align-items: center;
    }

    .summary-item {
        display: flex;
        align-items: baseline;
        gap: 0.5rem;
    }

    .summary-label {
        font-size: 0.9rem;
        color: var(--text-light);
    }

    .summary-value {
        font-size: 1.1rem;
        font-weight: bold;
        color: var(--primary-color);
    }

    .empty-mark {
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        /* Slighly larger */
        font-weight: bold;
        color: #555;
        /* Same as stat-label light */
        opacity: 1;
    }

    body.dark .empty-mark {
        color: #bbb;
        /* Same as stat-label dark */
    }

    /* Empty cell styling for start/end of month */
    .empty-cell {
        background-color: var(--bg-light);
        opacity: 0.5;
    }

    body.dark .empty-cell {
        background-color: #666;
        /* Lighter gray as requested */
        opacity: 0.2;
    }
</style>

<div class="card full-screen-card">
    <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; position: relative;">
        <h2 style="flex-grow: 1;">{{ doctor.name }} {{ (current_year|string)[-2:] }}年{{ current_month }}月 工作量</h2>

        <!-- Mobile Toggle Button -->
        <button class="action-toggle-btn" onclick="toggleWorkloadControls()" style="margin-left: 0.5rem;">
            ☰
        </button>

        <!-- Collapsible Container -->
        <div class="workload-header-controls" id="workloadControls">
            <div class="summary-bar">
                <div class="summary-item">
                    <span class="summary-label">项目数:</span>
                    <span class="summary-value">{{ total_items }}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">总分:</span>
                    <span class="summary-value">{{ total_score }}</span>
                </div>
            </div>

            <div class="action-bar"
                style="position: static; box-shadow: none; padding: 0; background: none; border: none; min-width: 0;">
                <a href="{{ url_for('workload_stats', year=current_year, month=current_month) }}"
                    class="btn-outline">返回统计</a>
            </div>
        </div>
    </div>

    <script>
        function toggleWorkloadControls() {
            var controls = document.getElementById('workloadControls');
            controls.classList.toggle('show');
        }

        // Close when clicking outside
        document.addEventListener('click', function (event) {
            var controls = document.getElementById('workloadControls');
            var toggleBtn = document.querySelector('.action-toggle-btn');

            if (!controls.contains(event.target) && !toggleBtn.contains(event.target)) {
                controls.classList.remove('show');
            }
        });
    </script>

    <div class="calendar-container">
        <div class="calendar-grid">
            <div class="calendar-header">周一</div>
            <div class="calendar-header">周二</div>
            <div class="calendar-header">周三</div>
            <div class="calendar-header">周四</div>
            <div class="calendar-header">周五</div>
            <div class="calendar-header" style="color: #dc3545;">周六</div>
            <div class="calendar-header" style="color: #dc3545;">周日</div>

            {% for day_data in calendar_data %}
            {% if day_data is none %}
            <div class="calendar-cell empty-cell"></div>
            {% else %}
            <a href="{{ url_for('doctor_daily_workload', doctor_id=doctor.id, year=current_year, month=current_month, day=day_data.day) }}"
                class="calendar-link">
                <div class="calendar-cell {{ day_data.status }}">
                    <div class="date-number">{{ day_data.day }}</div>

                    {% if day_data.status == 'holiday' %}
                    <div class="calendar-tag tag-holiday">{{ day_data.holiday_name if day_data.holiday_name else '休' }}
                    </div>
                    {% elif day_data.status == 'workday' and (loop.index % 7 == 6 or loop.index % 7 == 0) %}
                    <div class="calendar-tag tag-workday">班</div>
                    {% endif %}

                    {% if day_data.item_count > 0 %}
                    <div style="margin-top: auto;">
                        <div class="stat-item">
                            <span class="stat-label">项目</span>
                            <span class="stat-value">{{ day_data.item_count }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">分数</span>
                            <span class="stat-value score-value">{{ day_data.score }}</span>
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-mark">
                        /
                    </div>
                    {% endif %}
                </div>
            </a>
            {% endif %}
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}