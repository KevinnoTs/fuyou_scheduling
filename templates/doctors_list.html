{% extends "base.html" %}

{% block wrapper_class %}fixed-wrapper{% endblock %}

{% block content %}
<div class="card full-screen-card">
    <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; position: relative;">
        <h2 style="flex-grow: 1;">åŒ»ç”Ÿåˆ—è¡¨</h2>
        <button class="action-toggle-btn" onclick="toggleActions()">
            â˜°
        </button>
        <div class="action-bar" id="doctorActions">
            <div class="action-content-wrapper">
                <input type="text" id="searchInput" class="form-control form-search-input" placeholder="æœç´¢åŒ»ç”Ÿå§“åæˆ–æ“…é•¿..."
                    onkeyup="filterTable()">

                {% if current_user.role in ['admin', 'super_admin'] %}
                <a href="{{ url_for('add_doctor') }}" class="btn-primary">ï¼‹ æ·»åŠ åŒ»ç”Ÿ</a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="table-container">
        <table id="doctorsTable">
            <thead>
                <tr>
                    <th style="width: 4rem; min-width: 4rem; text-align: center;">å¤´åƒ</th>
                    <th style="width: 5rem; min-width: 5rem;">å§“å</th>
                    <th style="width: 3rem; min-width: 3rem;">æ€§åˆ«</th>
                    <th style="width: 5rem; min-width: 5rem;">èŒåŠ¡</th>
                    <th style="width: 9rem; min-width: 9rem;">æ“…é•¿æ–¹å‘</th>
                    <th style="width: 8rem; min-width: 8rem;">å¹´å‡ (å·²ä¼‘/æ€»è®¡)</th>
                    <th style="width: 3rem; min-width: 3rem;">çŠ¶æ€</th>
                    {% if current_user.role in ['admin', 'super_admin'] %}
                    <th style="width: 4rem; min-width: 4rem; text-align: center;">æ“ä½œ</th>
                    {% endif %}
                    <!-- Spacer Column -->
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for doctor in doctors %}
                <tr {% if current_user.doctor_id==doctor.id %}class="current-user-row" {% endif %}>
                    <td style="text-align: center; padding: 0.5rem;">
                        <div style="position: relative; display: inline-block;">
                            {% if doctor.avatar_path %}
                            <img src="{{ url_for('static', filename=doctor.avatar_path) }}" alt="{{ doctor.name }}"
                                style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color);">
                            {% else %}
                            {% set default_avatar = 'images/doctor-male.jpg' if doctor.gender == 'ç”·' else
                            'images/doctor-female.jpg' %}
                            <img src="{{ url_for('static', filename=default_avatar) }}" alt="{{ doctor.name }}"
                                style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color);">
                            {% endif %}

                            {% if current_user.role in ['admin', 'super_admin'] or current_user.doctor_id == doctor.id
                            %}
                            <form action="{{ url_for('upload_doctor_avatar', id=doctor.id) }}" method="post"
                                enctype="multipart/form-data" style="position: absolute; bottom: -5px; right: -5px;">
                                <label for="avatar-upload-{{ doctor.id }}"
                                    style="cursor: pointer; background: white; border-radius: 50%; padding: 2px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                    ğŸ“·
                                </label>
                                <input type="file" id="avatar-upload-{{ doctor.id }}" name="avatar" accept="image/*"
                                    style="display: none;" onchange="this.form.submit()">
                            </form>
                            {% endif %}
                        </div>
                    </td>
                    <td style="font-weight: bold;">
                        {{ doctor.name }}
                        {% if current_user.doctor_id == doctor.id %}
                        <span
                            style="font-size: 0.7rem; background-color: var(--primary-color); color: white; padding: 1px 4px; border-radius: 4px; margin-left: 4px;">æˆ‘</span>
                        {% endif %}
                    </td>
                    <td>{{ doctor.gender }}</td>
                    <td>{{ doctor.title }}</td>
                    <td>
                        {% if 'åŒ»åŠ©' not in (doctor.title or '') %}
                        {% if doctor.specialty %}
                        {% for sp in doctor.specialty.split(',') %}
                        <span class="specialty-tag">{{ sp }}</span>
                        {% endfor %}
                        {% endif %}
                        {% endif %}
                    </td>
                    <td>
                        {% if 'åŒ»åŠ©' not in (doctor.title or '') %}
                        <span style="font-weight: bold; color: var(--primary-color);">{{ doctor.used_annual_leave_days
                            }}</span> / {{ doctor.annual_leave_days }}
                        {% endif %}
                    </td>
                    <td>
                        {% if doctor.status == 'active' %}
                        <span style="color: #27ae60; font-weight: bold;">åœ¨èŒ</span>
                        {% else %}
                        <span style="color: #d63031; font-weight: bold;">ç¦»èŒ</span>
                        <div style="font-size: 0.8rem; color: var(--text-light);">{{
                            doctor.resignation_date.strftime('%Y-%m') }}</div>
                        {% endif %}
                    </td>
                    {% if current_user.role in ['admin', 'super_admin'] %}
                    <td>
                        <a href="{{ url_for('edit_doctor', id=doctor.id) }}" class="btn-outline"
                            style="font-size: 0.8rem; padding: 0.3rem 0.8rem;">ç¼–è¾‘</a>
                    </td>
                    {% endif %}
                    <!-- Spacer Cell -->
                    <td></td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="{{ 9 if current_user.role in ['admin', 'super_admin'] else 8 }}"
                        style="text-align: center; padding: 2rem; color: var(--text-light);">
                        æš‚æ— åŒ»ç”Ÿæ•°æ®ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’æ·»åŠ ã€‚
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleActions() {
        var actions = document.getElementById('doctorActions');
        actions.classList.toggle('show');
    }

    // Close actions when clicking outside
    window.addEventListener('click', function (e) {
        var actions = document.getElementById('doctorActions');
        var btn = document.querySelector('.action-toggle-btn');
        if (!actions.contains(e.target) && !btn.contains(e.target) && actions.classList.contains('show')) {
            actions.classList.remove('show');
        }
    });

    function filterTable() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        const table = document.getElementById('doctorsTable');
        const tr = table.getElementsByTagName('tr');

        for (let i = 1; i < tr.length; i++) {
            // Skip if it's the "No data" row
            if (tr[i].getElementsByTagName('td').length < 2) continue;

            const nameTd = tr[i].getElementsByTagName('td')[1];
            const specialtyTd = tr[i].getElementsByTagName('td')[4];

            if (nameTd && specialtyTd) {
                const nameValue = nameTd.textContent || nameTd.innerText;
                const specialtyValue = specialtyTd.textContent || specialtyTd.innerText;

                if (nameValue.toLowerCase().indexOf(filter) > -1 || specialtyValue.toLowerCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
</script>
{% endblock %}