{% extends "base.html" %}

{% block content %}
<div class="card" style="max-width: 500px; margin: 0 auto;">
    <h2 style="text-align: center; color: var(--primary-color); margin-bottom: 2rem;">
        {{ title }}
    </h2>

    <form method="post">
        <div class="form-group">
            <label for="username">用户名 <span style="color: red;">*</span></label>
            <input type="text" id="username" name="username" class="form-control {% if user %}readonly-input{% endif %}"
                value="{{ user.username if user else '' }}" required {% if user %}readonly{% endif %}>
            {% if user %}
            <small style="color: var(--text-light);">用户名不可修改</small>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="real_name">真实姓名 <span style="color: red;">*</span></label>
            <input type="text" id="real_name" name="real_name" class="form-control"
                value="{{ user.real_name if user else '' }}" required>
        </div>

        {% if current_user.role == 'super_admin' %}
        <div class="form-group">
            <label for="role">角色</label>
            <select id="role" name="role" class="form-control">
                <option value="user" {% if not user or user.role=='user' %}selected{% endif %}>普通用户</option>
                <option value="admin" {% if user and user.role=='admin' %}selected{% endif %}>管理员</option>
                <option value="super_admin" {% if user and user.role=='super_admin' %}selected{% endif %}>超级管理员</option>
            </select>
        </div>
        {% else %}
        <!-- 普通管理员只能创建/编辑普通用户，隐藏角色选择 -->
        <input type="hidden" name="role" value="user">
        {% endif %}

        {% if current_user.role in ['admin', 'super_admin'] %}
        <div class="form-group">
            <label for="doctor_id">关联医生 (可选)</label>
            <select id="doctor_id" name="doctor_id" class="form-control">
                <option value="">-- 不关联 --</option>
                {% for doctor in doctors %}
                <option value="{{ doctor.id }}" {% if user and user.doctor_id==doctor.id %}selected{% endif %}>
                    {{ doctor.name }} ({{ doctor.title }})
                </option>
                {% endfor %}
            </select>
            <small style="color: var(--text-light);">关联后，该用户可以管理此医生的信息（如修改头像）</small>
        </div>
        {% endif %}

        <div class="form-group">
            <label for="password">密码</label>
            <input type="password" id="password" name="password" class="form-control" {% if not user %}required{% endif
                %} placeholder="{% if user %}若不修改请留空{% else %}请输入初始密码{% endif %}">
        </div>

        {% if user %}
        <div class="form-group" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
            <input type="checkbox" id="is_active" name="is_active" {% if user.is_active %}checked{% endif %}
                style="width: auto;">
            <label for="is_active" style="margin-bottom: 0;">启用该账户</label>
        </div>
        {% endif %}

        <div style="margin-top: 2rem; display: flex; gap: 1rem;">
            <button type="submit" class="btn-primary" style="flex: 1;">保存</button>
            <a href="{{ url_for('users_list') }}" class="btn-outline" style="flex: 1; text-align: center;">取消</a>
        </div>
    </form>

    {% if user and (current_user.role == 'super_admin' or (current_user.role == 'admin' and user.role == 'user')) %}
    {% if user.role != 'super_admin' and user.id != current_user.id %}
    <div style="margin-top: 2rem; border-top: 1px solid #eee; padding-top: 1rem;">
        <h4 style="color: #d63031; margin-bottom: 1rem;">危险操作</h4>
        <button type="button" class="btn-outline"
            style="width: 100%; color: #d63031; border-color: #d63031; cursor: pointer;" onclick="openDeleteModal()">
            删除该用户
        </button>
    </div>

    <!-- 自定义删除确认模态框 -->
    <div id="deleteModal" class="delete-modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 style="color: #d63031; margin-bottom: 1rem;">⚠️ 确认删除</h3>
            <p style="margin-bottom: 1.5rem; color: #666;">
                确定要彻底删除用户 <strong>{{ user.username }}</strong> 吗？<br>
                此操作不可恢复！
            </p>
            <div style="display: flex; gap: 1rem;">
                <button type="button" class="btn-outline" onclick="closeDeleteModal()"
                    style="flex: 1; padding: 0.6rem 0;">取消</button>
                <form action="{{ url_for('delete_user', id=user.id) }}" method="post"
                    style="flex: 1; margin: 0; display: flex;">
                    <button type="submit" class="btn-primary"
                        style="width: 100%; background-color: #d63031; border-color: #d63031; padding: 0.6rem 0;">确认删除</button>
                </form>
            </div>
        </div>
    </div>

    <style>
        .delete-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>

    <script>
        function openDeleteModal() {
            document.getElementById('deleteModal').style.display = 'flex';
        }
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
        }
        // 点击遮罩层关闭
        document.getElementById('deleteModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });
    </script>
    {% endif %}
    {% endif %}
</div>
{% endblock %}