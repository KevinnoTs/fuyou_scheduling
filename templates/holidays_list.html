{% extends "base.html" %}

{% block wrapper_class %}fixed-wrapper{% endblock %}

{% block content %}
<div class="card full-screen-card">
    <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; position: relative;">
        <h2>èŠ‚å‡æ—¥ç®¡ç†</h2>
        <button class="action-toggle-btn" onclick="toggleActions()">
            â˜°
        </button>
        <div class="action-bar" id="holidayActions">
            <form action="{{ url_for('holidays_list') }}" method="get">
                <select name="year" class="form-control" onchange="this.form.submit()" style="width: 120px;">
                    {% for y in range(2025, 2031) %}
                    <option value="{{ y }}" {% if y==current_year %}selected{% endif %}>{{ y }}å¹´</option>
                    {% endfor %}
                </select>
            </form>
            {% if current_user.role in ['admin', 'super_admin'] %}
            <div class="holiday-actions-group">
                <a href="https://sousuo.www.gov.cn/sousuo/search.shtml?code=17da70961a7&searchBy=title&dataTypeId=15&advance=&searchMode=&searchWord=%E9%83%A8%E5%88%86%E8%8A%82%E5%81%87%E6%97%A5%E5%AE%89%E6%8E%92%E7%9A%84%E9%80%9A%E7%9F%A5"
                    target="_blank" class="btn-primary">
                    æŸ¥çœ‹å®‰æ’
                </a>
                <button onclick="openImportModal()" class="btn-primary" id="importBtn">
                    æ–‡å­—å¯¼å…¥
                </button>
                <a href="{{ url_for('add_holiday') }}" class="btn-primary">ï¼‹ æ·»åŠ èŠ‚å‡æ—¥</a>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th style="width: 20%;">æ—¥æœŸ</th>
                    <th style="width: 15%;">æ˜ŸæœŸ</th>
                    <th style="width: 25%;">åç§°</th>
                    <th style="width: 15%;">ç±»å‹</th>
                    {% if current_user.role in ['admin', 'super_admin'] %}
                    <th style="width: 25%;">æ“ä½œ</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% if holidays %}
                {% for holiday in holidays %}
                <tr>
                    <td>{{ holiday.date }}</td>
                    <td>
                        {% set weekdays = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'] %}
                        å‘¨{{ weekdays[holiday.date.weekday()] }}
                    </td>
                    <td>{{ holiday.name }}</td>
                    <td>
                        {% if holiday.type == 'holiday' %}
                        <span style="color: #d63031; font-weight: bold;">æ”¾å‡</span>
                        {% else %}
                        <span style="color: #27ae60; font-weight: bold;">è°ƒä¼‘</span>
                        {% endif %}
                    </td>
                    {% if current_user.role in ['admin', 'super_admin'] %}
                    <td>
                        <a href="{{ url_for('edit_holiday', id=holiday.id) }}" class="btn-outline"
                            style="font-size: 0.8rem; padding: 0.3rem 0.8rem; margin-right: 5px;">ç¼–è¾‘</a>
                        <button
                            onclick='openDeleteModal({{ holiday.id }}, {{ holiday.name|tojson }}, "{{ holiday.date }}")'
                            class="btn-outline"
                            style="font-size: 0.8rem; padding: 0.3rem 0.8rem; border-color: #d63031; color: #d63031;">åˆ é™¤</button>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
                {% endif %}

                {% if not holidays %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-light);">
                        æš‚æ— æœ¬å¹´åº¦èŠ‚å‡æ—¥æ•°æ®ã€‚
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    {% if current_user.role in ['admin', 'super_admin'] and holidays %}
    <div style="text-align: right; margin-top: 1rem; padding-right: 1rem; color: #666; font-size: 0.9rem;">
        æœ¬å¹´åº¦è®°å½•: <strong style="color: var(--primary-color);">{{ total_count }}</strong> æ¡
    </div>
    {% endif %}
</div>

<!-- å¯¼å…¥æ¨¡æ€æ¡† -->
<div id="importModal" class="modal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content-old"
        style="background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 600px; border-radius: 8px;">
        <span class="close" onclick="closeImportModal()"
            style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h3>ğŸ“ å¯¼å…¥èŠ‚å‡æ—¥æ–‡å­—</h3>
        <p style="color: #666; font-size: 0.9rem;">è¯·å°†å›½åŠ¡é™¢å‘å¸ƒçš„èŠ‚å‡æ—¥å®‰æ’æ–‡å­—ç²˜è´´åˆ°ä¸‹æ–¹ï¼ˆåŒ…å«â€œæ”¾å‡â€å’Œâ€œä¸Šç­â€ç­‰å…³é”®è¯ï¼‰ï¼š</p>
        <textarea id="importText" rows="10"
            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin: 10px 0; font-family: inherit;"
            placeholder="ä¾‹å¦‚ï¼šä¸€ã€å…ƒæ—¦ï¼š1æœˆ1æ—¥ï¼ˆå‘¨ä¸‰ï¼‰æ”¾å‡1å¤©ï¼Œä¸è°ƒä¼‘ã€‚"></textarea>
        <div style="text-align: right; margin-top: 10px;">
            <button onclick="closeImportModal()" class="btn-outline" style="margin-right: 10px;">å–æ¶ˆ</button>
            <button onclick="submitImport()" class="btn-primary" id="submitImportBtn">å¼€å§‹è¯†åˆ«å¹¶å¯¼å…¥</button>
        </div>
    </div>
</div>

<!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† (æ–°æ ·å¼) -->
<div id="deleteModal" class="delete-modal-overlay" style="display: none;">
    <div class="modal-content-styled">
        <h3 style="color: #d63031; margin-bottom: 1rem;">âš ï¸ ç¡®è®¤åˆ é™¤</h3>
        <p style="margin-bottom: 1.5rem; color: #666;">
            ç¡®å®šè¦åˆ é™¤ <strong id="deleteHolidayName"></strong> (<span id="deleteHolidayDate"></span>) å—ï¼Ÿ<br>
            æ­¤æ“ä½œä¸å¯æ¢å¤ï¼
        </p>
        <div style="display: flex; gap: 1rem;">
            <button type="button" class="btn-outline" onclick="closeDeleteModal()"
                style="flex: 1; padding: 0.6rem 0;">å–æ¶ˆ</button>
            <button onclick="confirmDelete()" class="btn-primary"
                style="flex: 1; background-color: #d63031; border-color: #d63031; padding: 0.6rem 0;">ç¡®è®¤åˆ é™¤</button>
        </div>
    </div>
</div>

<style>
    /* æ–°æ¨¡æ€æ¡†æ ·å¼ */
    .delete-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        animation: fadeIn 0.3s ease-out;
    }

    .modal-content-styled {
        background-color: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 400px;
        text-align: center;
        animation: scaleIn 0.3s ease-out;
    }

    @keyframes scaleIn {
        from {
            transform: scale(0.9);
            opacity: 0;
            transform: scale(1);
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }
</style>

<script>
    let currentDeleteId = null;

    function openDeleteModal(id, name, date) {
        currentDeleteId = id;
        document.getElementById('deleteHolidayName').innerText = name;
        document.getElementById('deleteHolidayDate').innerText = date;
        document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
        currentDeleteId = null;
    }

    function confirmDelete() {
        if (currentDeleteId) {
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/holidays/delete/' + currentDeleteId;
            document.body.appendChild(form);
            form.submit();
        }
    }

    function openImportModal() {
        document.getElementById('importModal').style.display = 'block';
    }

    function closeImportModal() {
        document.getElementById('importModal').style.display = 'none';
    }

    // ç‚¹å‡»å¤–éƒ¨å…³é—­ (ä½¿ç”¨ addEventListener é¿å…è¦†ç›– base.html çš„é€»è¾‘)
    window.addEventListener('click', function (event) {
        var importModal = document.getElementById('importModal');
        var deleteModal = document.getElementById('deleteModal');
        if (event.target == importModal) {
            importModal.style.display = "none";
        }
        if (event.target == deleteModal) {
            deleteModal.style.display = "none";
        }
    });

    function submitImport() {
        var text = document.getElementById('importText').value;
        if (!text.trim()) {
            alert('è¯·ç²˜è´´å†…å®¹');
            return;
        }

        var btn = document.getElementById('submitImportBtn');
        var originalText = btn.innerText;
        btn.innerText = 'å¤„ç†ä¸­...';
        btn.disabled = true;

        var formData = new FormData();
        formData.append('text', text);
        // Year is now optional, parsed from text. But we can send current_year as fallback.
        formData.append('year', '{{ current_year }}');

        fetch("{{ url_for('import_holidays_text') }}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('å¯¼å…¥å¤±è´¥ï¼š' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('è¯·æ±‚å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•');
            })
            .finally(() => {
                btn.innerText = originalText;
                btn.disabled = false;
            });
    }

    function toggleActions() {
        var actions = document.getElementById('holidayActions');
        actions.classList.toggle('show');
    }

    // Close actions when clicking outside
    window.addEventListener('click', function (e) {
        var actions = document.getElementById('holidayActions');
        var btn = document.querySelector('.action-toggle-btn');
        if (!actions.contains(e.target) && !btn.contains(e.target) && actions.classList.contains('show')) {
            actions.classList.remove('show');
        }
    });
</script>
{% endblock %}