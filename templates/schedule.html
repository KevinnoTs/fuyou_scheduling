{% extends "base.html" %}

{% block wrapper_class %}fixed-wrapper{% endblock %}

{% block content %}
<div class="card full-screen-card">
    <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; position: relative;">
        <h2 style="flex-grow: 1;">排班表</h2>
        <button class="action-toggle-btn" onclick="toggleActions()">
            ☰
        </button>

        <div class="action-bar" id="scheduleActions">
            <div class="action-content-wrapper">
                <form action="{{ url_for('schedule') }}" method="get" class="form-inline"
                    style="display: flex; gap: 0.5rem; align-items: center;">
                    <select name="year" class="form-control schedule-select-year" onchange="this.form.submit()">
                        {% for y in range(2025, 2031) %}
                        <option value="{{ y }}" {% if y==year %}selected{% endif %}>{{ y }}年</option>
                        {% endfor %}
                    </select>
                    <select name="month" class="form-control schedule-select-month" onchange="this.form.submit()">
                        {% for m in range(1, 13) %}
                        <option value="{{ m }}" {% if m==month %}selected{% endif %}>{{ m }}月</option>
                        {% endfor %}
                    </select>
                </form>

                {% if current_user.role in ['admin', 'super_admin'] %}
                <button class="btn-primary" onclick="openUploadModal()">
                    导入排班表
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="table-container">
        <table class="schedule-table" id="scheduleTable" data-year="{{ year }}" data-month="{{ month }}">
            <thead>
                <!-- Date Row -->
                <tr>
                    <th class="sticky-col first-col">日期</th>
                    {% for d in dates %}
                    <th class="{% if d.is_holiday %}holiday-col{% endif %}" data-day="{{ d.day }}">{{ d.day }}</th>
                    {% endfor %}
                </tr>
                <!-- Weekday Row -->
                <tr>
                    <th class="sticky-col first-col">姓名</th>
                    {% set week_names = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'] %}
                    {% for d in dates %}
                    <th class="{% if d.is_holiday %}holiday-col{% endif %}" data-day="{{ d.day }}">
                        {{ week_names[d.weekday] }}
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                <!-- Doctors Group -->
                {% for doctor in doctors_group %}
                <tr class="{% if current_user.doctor_id == doctor.id %}current-user-row{% endif %}">
                    <td class="sticky-col first-col">
                        <a href="{{ url_for('doctor_schedule_calendar', doctor_id=doctor.id, year=year, month=month) }}"
                            style="color: inherit; text-decoration: none; font-weight: bold;">
                            {{ doctor.name }}
                        </a>
                    </td>
                    {% for d in dates %}
                    <td class="schedule-cell" data-day="{{ d.day }}">
                        {% set shift = schedule_map.get((doctor.id, d.day), '') %}
                        {% if shift %}
                        {% set cls = '' %}
                        {% if '休' in shift or '假' in shift or '探亲' in shift %}
                        {% set cls = 'shift-rest-type' %}
                        {% elif '值' in shift %}
                        {% set cls = 'shift-duty-type' %}
                        {% elif '放射' in shift %}
                        {% set cls = 'shift-radiation' %}
                        {% endif %}
                        <span class="{{ cls }}">{{ shift }}</span>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}

                <!-- Spacer Row -->
                <tr class="spacer-row">
                    <td class="sticky-col first-col"></td>
                    {% for d in dates %}
                    <td class="{% if d.is_holiday %}holiday-col{% endif %}"></td>
                    {% endfor %}
                </tr>

                <!-- Assistants Group -->
                {% for doctor in assistants_group %}
                <tr class="{% if current_user.doctor_id == doctor.id %}current-user-row{% endif %}">
                    <td class="sticky-col first-col">
                        <a href="{{ url_for('doctor_schedule_calendar', doctor_id=doctor.id, year=year, month=month) }}"
                            style="color: inherit; text-decoration: none; font-weight: bold;">
                            {{ doctor.name }}
                        </a>
                    </td>
                    {% for d in dates %}
                    <td class="schedule-cell" data-day="{{ d.day }}">
                        {% set shift = schedule_map.get((doctor.id, d.day), '') %}
                        {% if shift %}
                        {% set cls = '' %}
                        {% if '休' in shift or '假' in shift or '探亲' in shift %}
                        {% set cls = 'shift-rest-type' %}
                        {% elif '值' in shift or '夜' in shift %}
                        {% set cls = 'shift-duty-type' %}
                        {% elif '放射' in shift %}
                        {% set cls = 'shift-radiation' %}
                        {% endif %}
                        <span class="{{ cls }}">{{ shift }}</span>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Toast Container -->
<!-- Toast Container Removed (Using global flashMessages) -->

<!-- Upload Modal -->
<div id="uploadModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 450px;">
        <span class="modal-close" onclick="closeUploadModal()">&times;</span>
        <h3 class="modal-title" style="margin-bottom: 1.5rem;">导入排班表</h3>



        <div class="form-group">
            <label style="font-weight: bold; margin-bottom: 0.5rem; display: block;">上传已填好的表格</label>
            <input type="file" id="modal-upload-input" class="form-control" accept=".xlsx" style="padding: 0.5rem;">
        </div>

        <div class="form-group" style="display: flex; gap: 1rem;">
            <div style="flex: 1;">
                <label>目标年份</label>
                <select id="modal-upload-year" class="form-control schedule-select-year"
                    style="width: 100% !important;">
                    {% for y in range(2025, 2031) %}
                    <option value="{{ y }}" {% if y==year %}selected{% endif %}>{{ y }}年</option>
                    {% endfor %}
                </select>
            </div>
            <div style="flex: 1;">
                <label>目标月份</label>
                <select id="modal-upload-month" class="form-control schedule-select-month"
                    style="width: 100% !important;">
                    {% for m in range(1, 13) %}
                    <option value="{{ m }}" {% if m==month %}selected{% endif %}>{{ m }}月</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
            <button class="btn-outline" onclick="downloadTemplate()"
                style="flex: 1; justify-content: center; text-align: center;">
                下载模板
            </button>
            <button class="btn-primary" onclick="confirmUpload()"
                style="flex: 1; justify-content: center; text-align: center;">确认导入</button>
            <button class="btn-outline" onclick="closeUploadModal()"
                style="flex: 1; justify-content: center; text-align: center;">取消</button>
        </div>
    </div>
</div>

<script>
    // Toast Function
    function showToast(message, type = 'info') {
        showFlashMessage(message, type);
    }


    function toggleActions() {
        const actions = document.getElementById('scheduleActions');
        actions.classList.toggle('active');
    }

    function openUploadModal() {
        const modal = document.getElementById('uploadModal');
        modal.classList.add('active');
        document.getElementById('modal-upload-input').value = '';
    }

    function closeUploadModal() {
        const modal = document.getElementById('uploadModal');
        modal.classList.remove('active');
    }

    function confirmUpload() {
        const input = document.getElementById('modal-upload-input');
        const yearSelect = document.getElementById('modal-upload-year');
        const monthSelect = document.getElementById('modal-upload-month');

        if (!input.files || !input.files[0]) {
            showToast('请先选择要上传的文件', 'error');
            return;
        }

        const file = input.files[0];

        // Check file extension on client side too
        if (!file.name.endsWith('.xlsx')) {
            showToast('仅支持 .xlsx 格式的文件', 'error');
            return;
        }

        const year = yearSelect.value;
        const month = monthSelect.value;
        const formData = new FormData();
        formData.append('file', file);
        formData.append('year', year);
        formData.append('month', month);

        // Show loading state? for now just assume fast
        showToast('正在导入...', 'info');

        fetch('{{ url_for("upload_schedule") }}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    // Delay reload slightly to let user see toast
                    setTimeout(() => {
                        window.location.href = "{{ url_for('schedule') }}?year=" + year + "&month=" + month;
                    }, 1000);
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('系统错误，请检查网络或控制台', 'error');
            })
            .finally(() => {
                closeUploadModal();
            });
    }

    function downloadTemplate() {
        const year = document.getElementById('modal-upload-year').value;
        const month = document.getElementById('modal-upload-month').value;
        const url = `{{ url_for('download_schedule_template') }}?year=${year}&month=${month}`;
        window.location.href = url;
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Client-side date check
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1; // 0-indexed
        const currentDay = now.getDate();

        const table = document.getElementById('scheduleTable');
        const viewYear = parseInt(table.dataset.year);
        const viewMonth = parseInt(table.dataset.month);

        // Only highlight if viewing current month
        if (viewYear === currentYear && viewMonth === currentMonth) {
            const dayCells = document.querySelectorAll('[data-day="' + currentDay + '"]');
            dayCells.forEach(cell => {
                cell.classList.add('is-today');
            });
        }

        // Scroll Logic (after highlighting)
        // Try to find the intersection of current user and today
        const intersection = document.querySelector('.current-user-row .is-today');

        if (intersection) {
            // Best case: Center the specific cell
            intersection.scrollIntoView({
                behavior: 'auto',
                block: 'center',
                inline: 'center'
            });
        } else {
            // Fallback: Handle independently
            const todayEl = document.querySelector('.is-today');
            if (todayEl) {
                todayEl.scrollIntoView({
                    behavior: 'auto',
                    block: 'nearest',
                    inline: 'center'
                });
            }

            const userRow = document.querySelector('.current-user-row');
            if (userRow) {
                // If we already scrolled X for today, we don't want to reset it, so use inline: nearest
                userRow.scrollIntoView({
                    behavior: 'auto',
                    block: 'center',
                    inline: 'nearest'
                });
            }
        }
    });
</script>
{% endblock %}